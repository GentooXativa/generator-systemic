all: ensure-dependencies brand package qa check package-clean-up


ensure-dependencies:
	@echo "Ensuring docker is installed..."
	@docker info

brand:
	@echo "Creating our <%= name %> manifest file..."
	@node_modules/make-manifest/bin/make-manifest
	@cat ./manifest.json

package:
	@echo "Building our <%= name %> docker image..."
	@docker build --tag <%= name %> .
	@docker images

qa:
	@echo "Checking that our <%= name %> container tests dont fail..."
	@docker run --name <%= name %> --env SERVICE_ENV=build --entrypoint npm <%= name %> run qa
	@docker rm <%= name %>
	@docker ps -a

check:
	@echo "Checking that our <%= name %> container is up and running..."
	@docker run --name <%= name %> --publish 4000:4000 --detach <%= name %>
	@sleep 2
	@curl http://localhost:4000/__/manifest
	@docker stop <%= name %>
	@docker rm <%= name %>
	@docker ps -a

package-clean-up:
	@echo "Deleting our <%= name %> image..."
	@docker rmi <%= name %>
	@docker images